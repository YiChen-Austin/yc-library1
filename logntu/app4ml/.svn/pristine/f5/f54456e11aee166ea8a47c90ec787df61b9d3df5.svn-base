package com.mall.web.pay.action;

import java.math.BigDecimal;
import java.util.HashMap;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;

import javax.annotation.Resource;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.apache.log4j.Logger;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.servlet.ModelAndView;

import com.mall.common.util.BaseUtil;
import com.mall.web.mall.common.annotation.MemberAuth;
import com.mall.web.mall.common.utils.CkSessionUtils;
import com.mall.web.mall.common.utils.MallEnum;
import com.mall.web.mall.common.vo.DataJsonBean;
import com.mall.web.mall.common.vo.ServerZoneBean;
import com.mall.web.mall.domain.Order;
import com.mall.web.mall.member.service.WebMemberService;
import com.mall.web.mall.member.vo.WebMemberVo;
import com.mall.web.mall.order.service.OrderService;
import com.mall.web.mall.order.vo.WebOrderVo;
import com.mall.web.mall.third.alipay.AlipayConfig;
import com.mall.web.pay.service.PayInterfaceService;

@Controller
public class PayController {
	private static Logger logger = Logger.getLogger(PayController.class);

	@Resource(name = "webMemberService")
	private WebMemberService webMemberService;
	@Resource(name = "orderService")
	private OrderService orderService;
	@Resource(name = "payInterfaceService")
	private PayInterfaceService payInterfaceService;

	/**
	 * 游戏支付界面（无需登录）
	 * 
	 * @param request
	 * @param response
	 * @return
	 */
	@RequestMapping("/pay4nl")
	@MemberAuth(verifyLogin = false)
	public ModelAndView pay4nl(HttpServletRequest request, HttpServletResponse response, String returnUrl) {
		ModelAndView mav = new ModelAndView();
		mav.setViewName("person/pay/pay4nl");
		return mav;
	}

	/**
	 * 龙币支付界面（须登录）
	 * 
	 * @param request
	 * @param response
	 * @return
	 */
	@RequestMapping("/pay4l")
	@MemberAuth(verifyLogin = true)
	public ModelAndView pay4l(HttpServletRequest request, HttpServletResponse response, String returnUrl) {
		ModelAndView mav = new ModelAndView();
		mav.setViewName("person/pay/pay4l");
		return mav;
	}

	/**
	 * 获取区域服务器
	 * 
	 * @param request
	 * @param response
	 * @return
	 */
	@RequestMapping("/pay/serverZone")
	@ResponseBody
	@MemberAuth(verifyLogin = true)
	public Object serverZone(String serverId) {
		List<ServerZoneBean> value = new LinkedList<ServerZoneBean>();
		List<ServerZoneBean> list = null;
		if (BaseUtil.isEmpty(serverId)) {
			list = DataJsonBean.serverZoneBean.getSubZones();
		} else {
			ServerZoneBean zone = DataJsonBean.serverZoneMap.get(serverId);
			list = (zone != null ? zone.getSubZones() : null);
		}
		for (ServerZoneBean zone : list) {
			ServerZoneBean zoneBean = new ServerZoneBean();
			zoneBean.copySplValue(zone);
			value.add(zoneBean);
		}
		return value;
	}

	/**
	 * 获取用户所在区域服务器的角色列表
	 * 
	 * @param request
	 * @param response
	 * @return
	 */
	@RequestMapping("/pay/serverRole")
	@ResponseBody
	@MemberAuth(verifyLogin = true)
	public Object serverRole(HttpServletResponse response, String userName, String serverId) {
		try {
			String roles = "[{\"roleId\":\"abcde-efadfee-xafeef-xxxxx\",\"roleName\":\"杀破浪\"},{\"roleId\":\"abcde-efadfee-xafeef-ffff\",\"roleName\":\"东西南白\"}]";
			response.setContentType("text/html;charset=UTF-8");
			response.getOutputStream().write(roles.getBytes("UTF-8"));
		} catch (Exception e) {
			e.printStackTrace();
			logger.warn(e);
		}
		return null;
	}

	/**
	 * 获取用户名是否存在
	 * 
	 * @param request
	 * @param response
	 * @return
	 */
	@RequestMapping("/pay/validUn")
	@ResponseBody
	@MemberAuth(verifyLogin = true)
	public Object validUn(HttpServletResponse response, String userName) {
		Map<String, Integer> result = new HashMap<String, Integer>();
		try {
			if (BaseUtil.isEmpty(userName) || BaseUtil.isEmpty(webMemberService.getUserInfo(userName))) {
				result.put(MallEnum.ServiceCodeType.ServiceCode, MallEnum.ServiceCodeType.DataErr.getIndex());
			} else {
				result.put(MallEnum.ServiceCodeType.ServiceCode, MallEnum.ServiceCodeType.Success.getIndex());
			}
		} catch (Exception e) {
			result.put(MallEnum.ServiceCodeType.ServiceCode, MallEnum.ServiceCodeType.SysErr.getIndex());
			e.printStackTrace();
			logger.warn(e);
		}
		return result;
	}

	/**
	 * 获取用户名、所在服務器id角色是否存在
	 * 
	 * @param request
	 * @param response
	 * @return
	 */
	@RequestMapping("/pay/validUnRl")
	@ResponseBody
	@MemberAuth(verifyLogin = true)
	public Object validUnRl(HttpServletResponse response, String userName, String serverCode, String roleCode) {
		Map<String, Integer> result = new HashMap<String, Integer>();
		try {
			if (BaseUtil.isEmpty(userName) || BaseUtil.isEmpty(serverCode) || BaseUtil.isEmpty(roleCode)) {
				result.put(MallEnum.ServiceCodeType.ServiceCode, MallEnum.ServiceCodeType.DataErr.getIndex());
			} else if (BaseUtil.isEmpty(webMemberService.getUserInfo(userName))) {
				result.put(MallEnum.ServiceCodeType.ServiceCode, MallEnum.ServiceCodeType.OtherErr.getIndex());
			} else {
				result.put(MallEnum.ServiceCodeType.ServiceCode, MallEnum.ServiceCodeType.Success.getIndex());
			}
		} catch (Exception e) {
			result.put(MallEnum.ServiceCodeType.ServiceCode, MallEnum.ServiceCodeType.SysErr.getIndex());
			e.printStackTrace();
			logger.warn(e);
		}
		return result;
	}

	/*******************************/
	/**
	 * 支付(支付宝)
	 * 
	 * @param request
	 * @param response
	 * @return
	 */
	@RequestMapping("/pay/ali")
	@MemberAuth(verifyLogin = true)
	public ModelAndView alipay(HttpServletRequest request, HttpServletResponse response, String userName,
			WebOrderVo orderVo) {
		ModelAndView mav = new ModelAndView();
		//判断提交处理返回路径
		String return_url="person/pay/pay4nl";
		String referer = request.getHeader("Referer");
		//充值游戏
		if(!BaseUtil.isEmpty(referer)&&referer.indexOf("pay4nl")>=0){
			return_url="person/pay/pay4nl";
		}//充值游戏
		else if(!BaseUtil.isEmpty(referer)&&referer.indexOf("pay4l")>=0){
			return_url="person/pay/pay4l";
		}
		
		Map<String, Integer> result = new HashMap<String, Integer>();
		if (BaseUtil.isEmpty(userName)) {
			result.put(MallEnum.ServiceCodeType.ServiceCode, MallEnum.ServiceCodeType.DataErr.getIndex());
			mav.setViewName(return_url);
			return mav;
		}
		// 受益用户信息
		WebMemberVo benefit = webMemberService.getUserInfo(userName);
		if (BaseUtil.isEmpty(benefit)) {
			result.put(MallEnum.ServiceCodeType.ServiceCode, MallEnum.ServiceCodeType.DataErr.getIndex());
			mav.setViewName(return_url);
			return mav;
		}
		String type=MallEnum.GoodsType.dragon.getIndex();
		//判断用户是否在所在服务器有指定角色
		if(!BaseUtil.isEmpty(orderVo.getServerCode())||!BaseUtil.isEmpty(orderVo.getRoleCode())){
			//TODO 有效判断（暂时未实现）
			type=MallEnum.GoodsType.direct.getIndex();						
		}
		//TODO 测试使用
		orderVo.setOrderAmount(BigDecimal.valueOf(0.01));
		// 登陆用户信息
		WebMemberVo user = CkSessionUtils.getUser(request);	
		user=(user==null?benefit:user);
		/*******/
		//处理业务(保存訂單)
		Order order=orderService.saveOrder(user==null?benefit:user, benefit, orderVo, type);
		//处理支付
		try {
			String sHtmlText=payInterfaceService.bankAlipay(
					order.getOrderSn().split(","),
					order.getType(),
					order.getOrderAmount().floatValue(), user.getUserId(),
					AlipayConfig.subject, AlipayConfig.body+":"+order.getOrderAmount().floatValue(),
					AlipayConfig.show_Url, AlipayConfig.anti_phishing_key,
					AlipayConfig.exter_invoke_ip);
			response.setContentType("text/html;charset=UTF-8");
			response.getWriter().write(sHtmlText);
		} catch (Exception e) {
			e.printStackTrace();
			logger.warn(e);
		}		
		return null;
	}
}
